---
title: "類似画像検索ツールを作ってみる (1) 序章"
emoji: "🔍"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["machinelearning", "deeplearning", "computervision", "python", "検索"]
published: false
---

# 背景と目的

『[けしからん画像分類器を作ってみる](202102-pornography-classifier-1)』シリーズで紹介した画像分類器を実装する過程で、多くの画像をラベル付けしました。
その際に困った事象に遭遇しました。重複した画像が思ったより多いこと多いこと。
インターネット上の「けしからん画像」には転載が多く、1ビットの相違もないファイルもあれば、拡大縮小、微妙な切り取り、マスキング、ウォーターマークの付加、再エンコードによる劣化など、「人間にとってはほとんど同じだけれど異なるビット列」の画像が大量に存在します。

機械学習のためのラベル付けするのであれば、できるだけユニークで広く分布した画像にラベル付けしたいものです。
内容がほとんど同じ画像にラベル付けしても精度の向上は期待できず、むしろ分布の偏りを生んでしまいます。

色々探してはみましたが、ちょうど良い感じの類似画像検索ツールが見当たらなかったので、画像処理、機械学習の学習も兼ねて作ってみることにしました。

## 参考: 既存の類似画像検索ツール

既存の類似画像検索ツールとして「Apache alike」があるみたいですが、公式サイトが無くなっている上、Apache Mahout、Apache Lucene、Apache Solr・・・と割と大がかりな感じなので、動かす前から諦めてしまいました。

# 目標

実装するにあたって目標を設定したいと思います。

具体的には、「10万枚の画像を、CPUだけを使って（GPUを使わずに）、1秒以内に検索し、類似度が高い順にソートして出力すること」を目標とします。

その他、オプショナルな要件（と言うか方針）は以下の通りです。

* 現実的な速度でインデックスを生成できること。
    * インデックスの生成にはGPUを使用すること。
* 容易に画像をインデックスに追加できること。
* Dockerコンテナ内で動作すること。
* Pythonで実装すること。

# 画像の類似度

「類似画像検索」というからには、何らかの方法を用いて「画像間の距離」（類似度）を定義する必要があります。

例えば、今回が検索の対象とする画像は800×1400ピクセルくらいの解像度があり、色深度はRGB各8ビットです。
そのため、800ピクセル × 1400ピクセル × 3チャネルで3,360,000個の8ビット整数が存在します。
同じ解像度、同じ色深度の画像を比較する場合、3,360,000個の整数同士のユークリッド距離を取ることもできますが、もっと対極的な、全体的な特徴を比較して欲しいですね。

古典的な（機械学習を使わない）特徴量として「AKAZE」などがありますが、今回は機械学習の勉強も兼ねているので、機械学習をベースとした特徴量を使ってみたいと思います。
具体的には、画像分類などで使われるモデルのバックボーン部分の出力を使います。
