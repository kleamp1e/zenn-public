---
title: "ã‚»ã‚¯ã‚·ãƒ¼å¥³å„ªã®é¡”ç‰¹å¾´é‡ã‚’UMAPã§æ¬¡å…ƒå‰Šæ¸›ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã¿ãŸ"
emoji: "ğŸ‘™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["machinelearning", "deeplearning", "computervision", "python", "UMAP"]
published: true
---

# ç›®æ¬¡

1. [ç”»åƒã‹ã‚‰ã‚»ã‚¯ã‚·ãƒ¼å¥³å„ªã‚’æ¤œç´¢ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè£…ã—ã¦ã¿ãŸ](202202-pornstar-recognizer)
2. ã‚»ã‚¯ã‚·ãƒ¼å¥³å„ªã®é¡”ç‰¹å¾´é‡ã‚’UMAPã§æ¬¡å…ƒå‰Šæ¸›ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã¿ãŸï¼ˆæœ¬è¨˜äº‹ï¼‰

# ã¯ã˜ã‚ã«

å‰å›ã®è¨˜äº‹ã€[ç”»åƒã‹ã‚‰ã‚»ã‚¯ã‚·ãƒ¼å¥³å„ªã‚’æ¤œç´¢ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè£…ã—ã¦ã¿ãŸ](202202-pornstar-recognizer)ã€ã§ã¯ã€InsightFaceã‚’ä½¿ã„ã€ç”»åƒã‹ã‚‰é¡”æ¤œå‡ºã€é¡”èªè¨¼ã‚’è¡Œã£ã¦ã€é¡ä¼¼ã™ã‚‹ã‚»ã‚¯ã‚·ãƒ¼å¥³å„ªã‚’æ¤œç´¢ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸã€‚

ä»Šå›ã¯ãã®é¡”ç‰¹å¾´é‡ãƒ‡ãƒ¼ã‚¿ï¼ˆ1,000äººã€5,000æšåˆ†ï¼‰ã‚’ä½¿ã£ã¦ã€æ¬¡å…ƒå‰Šæ¸›ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã®å®Ÿé¨“ã‚’ã—ã¦ã¿ã¾ã—ãŸã€‚

å®Ÿé¨“ã¯Google Colaboratoryä¸Šã§è¡Œã„ã¾ã—ãŸã€‚ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
ä»Šå›ã€åˆã‚ã¦Google Colaboratoryã‚’ä½¿ã„ã¾ã—ãŸã€‚ã¨ã¦ã‚‚ä¾¿åˆ©ã§ã™ã­ã€‚

https://colab.research.google.com/drive/1Cd8WyLDJB_EHSh1m5kKOrNV9TQWKBZst?usp=sharing

# ä½•ã®ãŸã‚ã«æ¬¡å…ƒå‰Šæ¸›ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ã®ï¼Ÿ

ä»Šå›ä½¿ç”¨ã—ãŸé¡”ç‰¹å¾´é‡ã®ãƒ‡ãƒ¼ã‚¿ã¯ã€512æ¬¡å…ƒã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚
ã€Œç•°å¸¸ãªï¼ˆä»–äººã®ï¼‰é¡”ç‰¹å¾´é‡ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ï¼Ÿã€ã€ã€Œèª°ã¨èª°ãŒä¼¼ã¦ã„ã‚‹ã‹ï¼Ÿã€ã¨ã„ã£ãŸåˆ†æã‚’è¡Œã„ãŸã„ã®ã§ã™ãŒã€æ¬¡å…ƒæ•°ãŒé«˜ã„ã¨ç›´æ„Ÿçš„ã«å–ã‚Šæ‰±ã†ã®ãŒé›£ã—ã„ã®ã§ã€3æ¬¡å…ƒã€2æ¬¡å…ƒãªã©ã®ä½æ¬¡å…ƒã§è¡¨ç¾ã§ãã‚‹ã¨ä¾¿åˆ©ã§ã™ã€‚

ãŸã ã€ä»Šå›ã¯ã€ŒUMAPã‚’ä½¿ã£ã¦ã¿ã‚‹ã€ã®ãŒç›®çš„ã ã£ãŸã®ã§ã€å®Ÿã¯ä¸Šè¨˜ã®ç›®çš„ã¯å¾Œä»˜ã‘ã ã£ãŸã‚Šã—ã¾ã™ã€‚

# ä½•ã‚’ä½¿ã†ã®ï¼ŸUMAPã¨ã¯ï¼Ÿ

ã€Œæ¬¡å…ƒå‰Šæ¸›ã€ã¨èãã¨ã€t-SNEã‚’æ€ã„æµ®ã‹ã¹ã‚‹æ–¹ãŒå¤šã„ã‹ã¨æ€ã„ã¾ã™ã€‚ã¨è¨€ã†ã‹ã€ç§ãŒãã†ã§ã—ãŸã€‚
ãã‚“ãªä¸­ã€ã¤ã„æœ€è¿‘ã€ã€Œ[UMAP](https://umap-learn.readthedocs.io/en/latest/)ã€ã¨ã„ã†ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¨ã€ãã‚Œã‚’å®Ÿè£…ã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å­˜åœ¨ã‚’çŸ¥ã‚Šã¾ã—ãŸã€‚

t-SNEã¨æ¯”ã¹ã¦UMAPã®åˆ©ç‚¹ã¯ã€

* çµæœãŒå®‰å®šã—ã¦ã„ã‚‹ï¼ˆå†å®Ÿè¡Œã—ã¦ã‚‚è¿‘ã—ã„çµæœã‚’å¾—ã‚‰ã‚Œã‚‹ï¼‰
* æ–°ãŸãªãƒ‡ãƒ¼ã‚¿ã‚‚å†™åƒã§ãã‚‹ï¼ˆ`fit`ã¨`transform`ã‚’åˆ¥ã€…ã«å®Ÿè¡Œã§ãã‚‹ï¼‰
* é€†å†™åƒã§ãã‚‹ï¼ˆå…ƒã®æ¬¡å…ƒã«æˆ»ã›ã‚‹ï¼‰

ãªã©ãŒã‚ã‚Šã¾ã™ã€‚è©³ã—ãã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ãã ã•ã„ã€‚

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

UMAPã¯ã€`pip`ã‚³ãƒãƒ³ãƒ‰ã§ç°¡å˜ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```sh
pip install umap-learn
```

# å…·ä½“ä¾‹

UMAPã¯ã€ã€Œæ•™å¸«ã‚ã‚Šã€ã¨ã€Œæ•™å¸«ãªã—ã€ã®æ¬¡å…ƒå‰Šæ¸›ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã®ä¸¡æ–¹ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»¥ä¸‹ã«å…·ä½“çš„ãªä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚

## ãƒ‡ãƒ¼ã‚¿ã®å–å¾—

ã¾ãšã¯ã€é¡”ç‰¹å¾´é‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚`wget`ã‚’ä½¿ã†ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚

```sh
wget https://github.com/kleamp1e/pornstar-recognizer/raw/main/backend/db/actor.npy
```

`actor.npy`ã«ã¯ã€å¥³å„ªIDã€é¡”ç‰¹å¾´é‡ã®ãƒ™ã‚¯ãƒˆãƒ«ï¼ˆ512æ¬¡å…ƒï¼‰ãŒ1,000äººã€5,000æšåˆ†å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

```py
actors = np.load("actor.npy")
actors.dtype #=> dtype([('id', '<u2'), ('embedding', '<f2', (512,))])
actors.shape #=> (5000,)
```

## è‰²ã®ç”Ÿæˆ

æœ¬ç­‹ã‹ã‚‰ã¯ãšã‚Œã¾ã™ãŒã€å¯è¦–åŒ–ã®ãŸã‚ã«å¥³å„ªIDã«å¯¾å¿œã™ã‚‹è‰²ã‚’äº‹å‰ã«ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚HSVè‰²ç©ºé–“ã®è‰¯ã„æ„Ÿã˜ã®é ˜åŸŸã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã—ã¦ã„ã¾ã™ã€‚

```py
def make_random_colors(n_colors):
    h = np.random.rand(n_colors)
    s = np.random.rand(n_colors) * 0.6 + 0.4
    v = np.random.rand(n_colors) * 0.6 + 0.3
    rgb = [colorsys.hsv_to_rgb(h, s, v) for h, s, v in zip(h, s, v)]
    return rgb

def draw_colors(colors, cell_dx=10, cell_dy=10, background=(128, 128, 128)):
    cells = len(colors)
    cell_nx = math.ceil(math.sqrt(cells))
    image_dx = cell_nx * cell_dx
    image_dy = math.ceil(cells / cell_nx) * cell_dy
    image = Image.new("RGB", (image_dx, image_dy), background)
    draw = ImageDraw.Draw(image)
    for index, (r, g, b) in enumerate(colors):
        x = index % cell_nx
        y = index // cell_nx
        draw.rectangle(
            (x * cell_dx, y * cell_dy, (x + 1) * cell_dx, (y + 1) * cell_dy),
            fill=(int(r * 255), int(g * 255), int(b * 255)))
    return image

n_colors = len(np.unique(actors["id"]))
n_colors #=> 1000

np.random.seed(42)
colors = make_random_colors(n_colors)
draw_colors(colors)
```

å¯è¦–åŒ–ã—ãŸçµæœã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/ec84ab1652e9-20220216.png)

## æ•™å¸«ã‚ã‚Šã§æ¬¡å…ƒå‰Šæ¸›ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°

ã¾ãšã¯ã€æ•™å¸«ã‚ã‚Šã§æ¬¡å…ƒå‰Šæ¸›ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã¿ã¾ã™ã€‚ã“ã“ã§ã®æ•™å¸«ãƒ‡ãƒ¼ã‚¿ã¯å¥³å„ªIDã§ã™ã€‚

æ¬¡å…ƒæ•°ï¼ˆ`n_components`ï¼‰ã«ã¯`2`ã€è·é›¢é–¢æ•°ã«ã¯ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ï¼ˆ`cosine`ï¼‰ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

```py
reducer = umap.UMAP(n_components=2, metric="cosine")
reduced_embedding = reducer.fit_transform(actors["embedding"], actors["id"])
reduced_embedding.shape #=> (5000, 2)

plt.figure(figsize=(10, 10))
plt.scatter(
    reduced_embedding[:, 0],
    reduced_embedding[:, 1],
    c=[colors[id] for id in actors["id"]],
    marker="+")
```

å¯è¦–åŒ–ã—ãŸçµæœã¯ã€ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/7e80c824af79-20220216.png)

æ‰€ã€…ã€ã‚®ãƒ¥ãƒƒã¨å›ºã¾ã£ã¦ã„ã‚‹ç®‡æ‰€ãŒã‚ã‚Šã¾ã™ãŒã€å…¨ä½“çš„ã«ã¯ã°ã‚‰ã‘ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚
ã¾ãŸã€ãã‚Œãã‚Œã®å¥³å„ªIDã«5æšåˆ†ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ãŒã€é‡ãªã£ã¦1ã¤ã®ç‚¹ã«è¦‹ãˆã¾ã™ã€‚

## æ•™å¸«ãªã—ã§æ¬¡å…ƒå‰Šæ¸›ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°

ã“ã¡ã‚‰ãŒæœ¬ç­‹ã§ã™ãŒã€æ•™å¸«ãªã—ã§æ¬¡å…ƒå‰Šæ¸›ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã¿ã¾ã™ã€‚`fit_transform`ã«ç¬¬2å¼•æ•°ã‚’ä¸ãˆãªã„ã“ã¨ã§ã€æ•™å¸«ãªã—ãƒ¢ãƒ¼ãƒ‰ã§å‹•ãã¾ã™ã€‚

```py
reducer = umap.UMAP(n_components=2, metric="cosine")
reduced_embedding = reducer.fit_transform(actors["embedding"])
reduced_embedding.shape #=> (5000, 2)

plt.figure(figsize=(10, 10))
plt.scatter(
    reduced_embedding[:, 0],
    reduced_embedding[:, 1],
    c=[colors[id] for id in actors["id"]],
    marker="+")
```

å¯è¦–åŒ–ã—ãŸçµæœã¯ã€ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/4ce3aabd080a-20220216.png)

ã•ã™ãŒã«æ•™å¸«ãªã—ãªã®ã§å¥³å„ªIDæ¯ã®å‡é›†åº¦ã¯ä½ã‚ã§ã™ã€‚ãã‚Œã§ã‚‚åŒã˜å¥³å„ªIDã®ãƒ‡ãƒ¼ã‚¿ã¯è¿‘ãã«ãƒ—ãƒ­ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚

1,000äººåˆ†ã‚’ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹ã¨åŒºåˆ¥ãŒé›£ã—ã„ã®ã§ã€å…ˆé ­5äººåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã ã‘ã«è‰²ã‚’ä»˜ã‘ã¦ã¿ã¾ã™ã€‚

```py
plt.figure(figsize=(10, 10))
plt.scatter(
    reduced_embedding[:, 0],
    reduced_embedding[:, 1],
    color=(0.8, 0.8, 0.8),
    marker="+")
for id in np.unique(actors["id"]):
    if 0 <= id <= 4:
        selector = (actors["id"] == id)
        plt.scatter(
            reduced_embedding[:, 0][selector],
            reduced_embedding[:, 1][selector],
            c=[colors[id] for _ in range(np.sum(selector))],
            label=str(id),
            marker="+")
plt.legend()
```

å¯è¦–åŒ–ã—ãŸçµæœã¯ã€ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/bcdcf1ccb289-20220216.png)

å¥³å„ªID 0ã ã‘ã¯å‡é›†åº¦ãŒä½ã‚ã§ã™ãŒã€ä»–ã®å¥³å„ªIDã«ã¤ã„ã¦ã¯å‡é›†ã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚

## é€†å†™åƒ

Google Colaboratoryãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«ã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€2æ¬¡å…ƒâ†’512æ¬¡å…ƒã®é€†å†™åƒã‚‚å®Ÿé¨“ã—ã¦ã¿ã¾ã—ãŸã€‚
æ®‹å¿µãªãŒã‚‰ã“ã¡ã‚‰ã¯ä¸Šæ‰‹ãè¡Œã‹ãšã€ã€Œ512æ¬¡å…ƒâ†’2æ¬¡å…ƒâ†’512æ¬¡å…ƒã€ã®ã‚ˆã†ã«ã€Œå†™åƒâ†’é€†å†™åƒã€ã—ã¦é¡ä¼¼åº¦ã‚’è¨ˆç®—ã—ã¦ã¿ã¾ã—ãŸãŒã€ã¨ã¦ã‚‚ä½ã„é¡ä¼¼åº¦ã«ãªã‚Šã¾ã—ãŸã€‚

ä¸Šè¨˜ã®ã‚ˆã†ãªæ•£å¸ƒå›³ã®ä»»æ„ã®ç‚¹ã‚’é¸æŠã—ã€ãã®ç‚¹ã«è¿‘ã„å¥³å„ªã‚’æ¤œç´¢ã™ã‚‹ãƒ»ãƒ»ãƒ»ã¨ã„ã†ã“ã¨ã‚’ã‚„ã‚ŠãŸã‹ã£ãŸã®ã§ã™ãŒã€ãªã‹ãªã‹é›£ã—ãã†ã§ã™ã€‚

# æœ€å¾Œã«

UMAPã‚’ä½¿ã†ã“ã¨ã§ã€512æ¬¡å…ƒã‚’è‰¯ã„æ„Ÿã˜ã«æ¬¡å…ƒå‰Šæ¸›ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
ä»Šå¾Œã€ãƒ‡ãƒ¼ã‚¿ã®æ¢ç´¢ã€å¯è¦–åŒ–ãªã©ã«æ´»ã‹ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚
