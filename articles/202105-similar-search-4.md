---
title: "é¡ä¼¼ç”»åƒæ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’ä½œã£ã¦ã¿ã‚‹ (4) é¡ä¼¼ç”»åƒæ¤œç´¢"
emoji: "ğŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["machinelearning", "deeplearning", "computervision", "python", "æ¤œç´¢"]
published: true
---

# ç›®æ¬¡

* [é¡ä¼¼ç”»åƒæ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’ä½œã£ã¦ã¿ã‚‹ (1) åºç« ](202105-similar-search-1)
* [é¡ä¼¼ç”»åƒæ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’ä½œã£ã¦ã¿ã‚‹ (2) ç‰¹å¾´åŒ– ãã®1](202105-similar-search-2)
* [é¡ä¼¼ç”»åƒæ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’ä½œã£ã¦ã¿ã‚‹ (3) ç‰¹å¾´åŒ– ãã®2](202105-similar-search-3)
* é¡ä¼¼ç”»åƒæ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’ä½œã£ã¦ã¿ã‚‹ (4) é¡ä¼¼ç”»åƒæ¤œç´¢ï¼ˆæœ¬è¨˜äº‹ï¼‰
* [é¡ä¼¼ç”»åƒæ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’ä½œã£ã¦ã¿ã‚‹ (5) é¡ä¼¼ç”»åƒæ¤œç´¢ã‚µãƒ¼ãƒ](202105-similar-search-5)
* [é¡ä¼¼ç”»åƒæ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’ä½œã£ã¦ã¿ã‚‹ (6) Next.js + SVGã§å¯è¦–åŒ–](202106-similar-search-6)

# ã¤ã„ã«é¡ä¼¼ç”»åƒæ¤œç´¢ã¸

[å‰å›](202105-similar-search-3)ã€ç´„10ä¸‡æšã®ç”»åƒã«å¯¾ã—ã¦ç‰¹å¾´é‡ã‚’å–å¾—ã—ã€1ä¸‡æšã”ã¨ã«çµåˆã—ãŸç‰¹å¾´é‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸã€‚

ä»Šå›ã¯å®Ÿéš›ã«ã€ã“ã®ç‰¹å¾´é‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã£ã¦é¡ä¼¼ç”»åƒæ¤œç´¢ã‚’è¡Œã£ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# é¡ä¼¼ç”»åƒã‚’æ¤œç´¢ã™ã‚‹

é¡ä¼¼ç”»åƒã‚’æ¤œç´¢ã™ã‚‹å¤§ã¾ã‹ãªæµã‚Œã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

1. ONNXãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã€‚
2. ã‚¯ã‚¨ãƒªç”»åƒã‚’èª­ã¿è¾¼ã‚€ã€‚
3. ã‚¯ã‚¨ãƒªç”»åƒã‚’æ•´å½¢ã™ã‚‹ã€‚
4. ã‚¯ã‚¨ãƒªç”»åƒã®ç‰¹å¾´é‡ã‚’å–å¾—ã™ã‚‹ã€‚
5. å„ç‰¹å¾´é‡ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦:
    1. ç‰¹å¾´é‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã€‚
    2. ã‚¯ã‚¨ãƒªç”»åƒã®ç‰¹å¾´é‡ã¨ã®è·é›¢ã‚’æ±‚ã‚ã‚‹ã€‚ï¼ˆä»Šå›ã¯ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰è·é›¢ï¼‰
    3. è·é›¢ãŒè¿‘ã„é †ã«ã‚½ãƒ¼ãƒˆã™ã‚‹ã€‚
    4. ä¸Šä½nä»¶ã‚’ä¿å­˜ã™ã‚‹ã€‚
6. ã™ã¹ã¦ã®ç‰¹å¾´é‡ãƒ•ã‚¡ã‚¤ãƒ«ã®çµæœã‚’çµåˆã™ã‚‹ã€‚
7. ä¸Šä½nä»¶ã‚’å‡ºåŠ›ã™ã‚‹ã€‚

å®Ÿéš›ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚ä»Šå›ã¯`n=10`ã¨ã—ã¦ã„ã¾ã™ã€‚

```py:search.py
#!/usr/bin/env python3

import pathlib
import sys

import numpy as np
import onnxruntime
import PIL.Image

FEATURE_DIR = pathlib.Path("/mnt/feature/mobilenet_v3_large_100_224_feature_vector_v5")
ONNX_MODEL_PATH = pathlib.Path(
    "/mnt/model/mobilenet_v3_large_100_224_feature_vector_v5.onnx"
)

onnx_session = onnxruntime.InferenceSession(str(ONNX_MODEL_PATH))

image_path = pathlib.Path(sys.argv[1])

image = PIL.Image.open(image_path)
image = image.convert("RGB")
image = image.resize((224, 224))
image = np.array(image, dtype=np.float32)
image = image / 255

query_feature = onnx_session.run(
    ["feature_vector"], {"inputs:0": np.expand_dims(image, 0)}
)[0][0]

results = []
limit = 10

for blob_index in range(20):
    object_ids_path = FEATURE_DIR / "{:04d}.object_ids.npy".format(blob_index)
    features_path = FEATURE_DIR / "{:04d}.features.npy".format(blob_index)
    if not object_ids_path.exists():
        break

    object_ids = np.load(object_ids_path)
    features = np.load(features_path)
    assert len(object_ids) == len(features)

    query_features = np.tile(query_feature, (len(features), 1))

    distances = np.linalg.norm(query_features - features, axis=1)
    distance_indexes = np.argsort(distances)[:limit]
    results.extend(zip(object_ids[distance_indexes], distances[distance_indexes]))

for object_id, distance in sorted(results, key=lambda item: item[1])[0:limit]:
    print("{} {}".format(object_id, distance))
```

ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã«ã‚¯ã‚¨ãƒªç”»åƒã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

```
$ time ./src/search.py /mnt/media/object/55/77/5577b06378df4cbf5fa04237ac767205a944a360.jpg
5577b06378df4cbf5fa04237ac767205a944a360.jpg 0.0
877803e4c546ce3548b088cf734ee83a0c722a5a.jpg 0.39354559779167175
d5d1e73cb23b79ec05743c97bedd2f770adcbcaf.jpg 8.174514770507812
b6031e0d869b7b5e397e82f5db9dfaacd384f1a0.jpg 8.18053913116455
29e6a6c5885ff27a99d358065d3abb7856c723f3.jpg 8.67011833190918
924beb3a39b67a6c7e582d093d46928188e4be29.jpg 8.68422794342041
8e3aa1aaaaceb2bad287585c766927e5f1f218ca.jpg 10.661015510559082
d96c72edcf3062732f8c37ff339772b070cd195f.jpg 10.730582237243652
21793eb39f11ec24f42a643dec695264955a2300.jpg 11.072492599487305
42b2a6040589e68e734c4d1499b263992a2c5956.jpg 11.31399154663086

real    0m1.660s
user    0m1.307s
sys     0m1.169s
```

æ¤œç´¢çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚ã€[ã‘ã—ã‹ã‚‰ã‚“ç”»åƒåˆ†é¡å™¨ã‚’ä½œã£ã¦ã¿ã‚‹](202102-pornography-classifier-1)ã€ã‚·ãƒªãƒ¼ã‚ºã§ä½¿ç”¨ã—ãŸã€Œã‘ã—ã‹ã‚‰ã‚“ç”»åƒã€ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€å®Ÿéš›ã®æ¤œç´¢çµæœã‚’ãŠè¦‹ã›ã§ããªã„ã®ãŒæ®‹å¿µã§ã™ã€‚

1ç•ªç›®ã¯è·é›¢`0.0`ã¨ãªã£ã¦ã„ã¾ã™ã€‚ã‚¯ã‚¨ãƒªç”»åƒã¨ã—ã¦æŒ‡å®šã—ãŸ`5577b06378df4cbf5fa04237ac767205a944a360.jpg`ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ã‚‚å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€è·é›¢ã‚¼ãƒ­ã¨ãªã£ã¦ã„ã¾ã™ã€‚ã¡ã‚ƒã‚“ã¨å‹•ä½œã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã­ã€‚

2ç•ªç›®ã®è·é›¢`0.39...`ã®ç”»åƒã¯ã€ç¢ºã‹ã«ä¼¼ãŸç”»åƒã§ã—ãŸã€‚ã¨ã„ã†ã‹ã€åŒã˜ç”»åƒã®è‰²èª¿ãŒèª¿æ•´ã•ã‚ŒãŸç”»åƒã§ã—ãŸã€‚

ãã‚Œä»¥é™ã‚‚ã€åŒã˜äººç‰©ãŒå†™ã£ã¦ã„ã‚‹ã€åŒã˜æ§‹å›³ã€åŒã˜è‰²èª¿ãªã©ã€ç¢ºã‹ã«ã€Œä¼¼ã¦ã„ã‚‹ç”»åƒã€ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã™ã€‚
è·é›¢ãŒ`11`ã‚’è¶ŠãˆãŸè¾ºã‚Šã‹ã‚‰ã€Œä¼¼ã¦ã„ã‚‹â€¦ã‹ãªï¼Ÿã€ã¨ãªã£ã¦ãã¾ã™ã€‚

# ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰åŒ–

ä½•ã¨ãªãã€ãã‚Œã£ã½ã„é¡ä¼¼ç”»åƒæ¤œç´¢ã‚’è¡Œãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ãŸã ã€ç›®æ¨™ã¨ã—ã¦ã„ãŸã€Œ1ç§’ä»¥å†…ã€ãŒå®Ÿç¾ã§ãã¦ãŠã‚‰ãšã€1.6ç§’ã‚’è¦ã—ã¦ã„ã¾ã™ã€‚
1ç§’ä»¥å†…ã‚’ç›®æŒ‡ã™ãŸã‚ã«ã€å°‘ã—é«˜é€ŸåŒ–ã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ä¸Šè¨˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã¯ã€ç´„50MBã®ç‰¹å¾´é‡ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã¨æ¤œç´¢ã‚’é †æ¬¡è¡Œã£ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã‚’ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰åŒ–ã—ã¦ã¿ã¾ã™ã€‚
é¢å€’ãªã®ã§ã€ã¾ãšã¯ç‰¹å¾´é‡ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•°ã ã‘ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ç”Ÿæˆã—ã¦ã¿ã¾ã™ã€‚

```py:search.py
# ï¼ˆçœç•¥ï¼‰

import threading

def search(object_ids_path, features_path, query_feature, limit, results):
    object_ids = np.load(object_ids_path)
    features = np.load(features_path)
    assert len(object_ids) == len(features)

    query_features = np.tile(query_feature, (len(features), 1))
    distances = np.linalg.norm(query_features - features, axis=1)
    distance_indexes = np.argsort(distances)[:limit]
    results.extend(zip(object_ids[distance_indexes], distances[distance_indexes]))


results = []
search_threads = []
limit = 10

for blob_index in range(20):
    object_ids_path = FEATURE_DIR / "{:04d}.object_ids.npy".format(blob_index)
    features_path = FEATURE_DIR / "{:04d}.features.npy".format(blob_index)
    if not object_ids_path.exists():
        break

    search_thread = threading.Thread(
        target=search,
        args=(object_ids_path, features_path, query_feature, limit, results),
    )
    search_thread.start()
    search_threads.append(search_thread)

for search_thread in search_threads:
    search_thread.join()

# ï¼ˆçœç•¥ï¼‰
```

å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

```
$ time ./src/search.py /mnt/media/object/55/77/5577b06378df4cbf5fa04237ac767205a944a360.jpg
...
real    0m1.482s
user    0m1.541s
sys     0m1.743s
```

ãƒ»ãƒ»ãƒ»0.1ç§’ã—ã‹æ—©ããªã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãã‚‚ãã‚‚æ¤œç´¢å‡¦ç†ã¯ååˆ†ã«é«˜é€Ÿãªã‚ˆã†ã§ã™ã€‚

å„å‡¦ç†ã®æ™‚é–“ã‚’æ¸¬å®šã—ã¦ã¿ã‚‹ã¨ã€ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰ã«0.4ç§’ã€æ¨è«–ã«0.5ç§’æ›ã‹ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚
é«˜é€ŸåŒ–ã€æœ€é©åŒ–ã®ç¬¬1ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€Œæ¸¬å®šã€ã€‚ã‚„ã£ã±ã‚Šæ‰‹ã‚’æŠœã„ã¦ã¯ãƒ€ãƒ¡ã§ã™ã­ã€‚

# ä»Šæ—¥ã¯ã“ã“ã¾ã§

ä»Šå›ã¯å®Ÿéš›ã«é¡ä¼¼ç”»åƒã‚’æ¤œç´¢ã™ã‚‹ã¨ã“ã‚ã¾ã§å®Ÿæ–½ã§ãã¾ã—ãŸã€‚ãŸã ã€ç›®æ¨™ã¨ã™ã‚‹ã€Œ1ç§’ä»¥å†…ã€ã¯å®Ÿç¾ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚

æ¬¡å›ã¯æ¤œç´¢å‡¦ç†ã‚’ã‚µãƒ¼ãƒåŒ–ã—ã€ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã€ç‰¹å¾´é‡ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚’èµ·å‹•æ™‚ã«1å›ã ã‘è¡Œã†ã‚ˆã†ã«ã—ã¦ã€é«˜é€ŸåŒ–ã‚’å›³ã£ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚ä»Šæ—¥ã¯ã“ã“ã¾ã§ï¼

ã€[é¡ä¼¼ç”»åƒæ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’ä½œã£ã¦ã¿ã‚‹ (5) é¡ä¼¼ç”»åƒæ¤œç´¢ã‚µãƒ¼ãƒ](202105-similar-search-5)ã€ã«ç¶šãã€‚
