---
title: "é¡ä¼¼ç”»åƒæ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’ä½œã£ã¦ã¿ã‚‹ (6) å¯è¦–åŒ–"
emoji: "ğŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["machinelearning", "deeplearning", "computervision", "python", "æ¤œç´¢"]
published: true
---

# ç›®æ¬¡

* [é¡ä¼¼ç”»åƒæ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’ä½œã£ã¦ã¿ã‚‹ (1) åºç« ](202105-similar-search-1)
* [é¡ä¼¼ç”»åƒæ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’ä½œã£ã¦ã¿ã‚‹ (2) ç‰¹å¾´åŒ– ãã®1](202105-similar-search-2)
* [é¡ä¼¼ç”»åƒæ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’ä½œã£ã¦ã¿ã‚‹ (3) ç‰¹å¾´åŒ– ãã®2](202105-similar-search-3)
* [é¡ä¼¼ç”»åƒæ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’ä½œã£ã¦ã¿ã‚‹ (4) é¡ä¼¼ç”»åƒæ¤œç´¢](202105-similar-search-4)
* [é¡ä¼¼ç”»åƒæ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’ä½œã£ã¦ã¿ã‚‹ (5) é¡ä¼¼ç”»åƒæ¤œç´¢ã‚µãƒ¼ãƒ](202105-similar-search-5)
* é¡ä¼¼ç”»åƒæ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’ä½œã£ã¦ã¿ã‚‹ (6) å¯è¦–åŒ–ï¼ˆæœ¬è¨˜äº‹ï¼‰

# å¯è¦–åŒ–

[å‰å›](202105-similar-search-5)ã€é¡ä¼¼ç”»åƒæ¤œç´¢ã‚µãƒ¼ãƒã‚’å®Ÿè£…ã—ã€ã‚¦ã‚§ãƒ–APIçµŒç”±ã§é¡ä¼¼ç”»åƒã‚’æ¤œç´¢ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

ãŸã ã€ç”»åƒã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆIDã¨è·é›¢ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã ã‘ã§ã¯å‘³æ°—ãªãã€ç”»åƒã®è·é›¢æ„Ÿã‚’æ„Ÿã˜ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚
ãã“ã§ä»Šå›ã¯ã€é¡ä¼¼ç”»åƒæ¤œç´¢ã®çµæœã‚’å¯è¦–åŒ–ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# å¯è¦–åŒ–â€¦ãã®å‰ã«

ä»Šå›ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å«ã¾ã‚Œã‚‹ç”»åƒã¯ã€Œã‘ã—ã‹ã‚‰ã‚“ç”»åƒã€ã°ã‹ã‚Šã§ã™ã€‚
ãã®ãŸã‚ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ãã®ã¾ã¾æ²è¼‰ã™ã‚‹ã¨ä½•ã‚‰ã‹ã®è¦ç´„ã«æŠµè§¦ã—ã€è¨˜äº‹ãŒå‰Šé™¤ã•ã‚Œã‚‹ã€ã‚ã‚‹ã„ã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã”ã¨ãƒãƒ³ã•ã‚Œã‹ã­ã¾ã›ã‚“ã€‚
ãã®ãŸã‚ã€ä»Šå›ã¯ã‚ã–ã‚ã–ã€Œç”»åƒã«ãƒ¢ã‚¶ã‚¤ã‚¯ã‚’æ›ã‘ã¦é…ä¿¡ã™ã‚‹ã‚µãƒ¼ãƒã€ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

ç‰¹ã«è§£èª¬ã—ã¾ã›ã‚“ãŒã€ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```py:censored-distributor/src/app.py
import io
import os
import pathlib

import flask
import flask_cors
import PIL.Image

MEDIA_DIR = pathlib.Path(os.environ["MEDIA_DIR"])
OBJECT_DIR = MEDIA_DIR / "object"


def make_nested_id_path(dir, id, ext=""):
    return dir / id[0:2] / id[2:4] / (id + ext)


app = flask.Flask(__name__)
flask_cors.CORS(app)


@app.route("/<string:object_id>")
def censored(object_id):
    image_path = make_nested_id_path(OBJECT_DIR, object_id)

    image = PIL.Image.open(image_path).convert("RGB")
    width, height = image.width, image.height
    block_size = 64
    image = image.resize((width // block_size, height // block_size), PIL.Image.NEAREST)
    image = image.resize((width, height), PIL.Image.NEAREST)

    bio = io.BytesIO()
    image.save(bio, format="JPEG")

    response = flask.make_response(bio.getvalue())
    response.headers.set("Content-Type", "image/jpeg")

    return response
```
