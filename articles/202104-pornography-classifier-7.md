---
title: "ã‘ã—ã‹ã‚‰ã‚“ç”»åƒåˆ†é¡å™¨ã‚’ä½œã£ã¦ã¿ã‚‹ (6) å­¦ç¿’ ãã®1"
emoji: "ğŸ‘™"
type: "idea" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["machinelearning", "deeplearning", "computervision", "python", "keras"]
published: false
---

# ç›®æ¬¡

* [ã‘ã—ã‹ã‚‰ã‚“ç”»åƒåˆ†é¡å™¨ã‚’ä½œã£ã¦ã¿ã‚‹ (1) åºç« ](202102-pornography-classifier-1)
* [ã‘ã—ã‹ã‚‰ã‚“ç”»åƒåˆ†é¡å™¨ã‚’ä½œã£ã¦ã¿ã‚‹ (2) ãƒ‡ãƒ¼ã‚¿åé›† ãã®1](202102-pornography-classifier-2)
* [ã‘ã—ã‹ã‚‰ã‚“ç”»åƒåˆ†é¡å™¨ã‚’ä½œã£ã¦ã¿ã‚‹ (3) ãƒ‡ãƒ¼ã‚¿åé›† ãã®2](202102-pornography-classifier-3)
* [ã‘ã—ã‹ã‚‰ã‚“ç”»åƒåˆ†é¡å™¨ã‚’ä½œã£ã¦ã¿ã‚‹ (4) ãƒ‡ãƒ¼ã‚¿åé›† ãã®3](202103-pornography-classifier-4)
* [ã‘ã—ã‹ã‚‰ã‚“ç”»åƒåˆ†é¡å™¨ã‚’ä½œã£ã¦ã¿ã‚‹ (5) ãƒ‡ãƒ¼ã‚¿ç®¡ç† ãã®1](202103-pornography-classifier-5)
* [ã‘ã—ã‹ã‚‰ã‚“ç”»åƒåˆ†é¡å™¨ã‚’ä½œã£ã¦ã¿ã‚‹ (6) ãƒ‡ãƒ¼ã‚¿ç®¡ç† ãã®2](202103-pornography-classifier-6)
* ã‘ã—ã‹ã‚‰ã‚“ç”»åƒåˆ†é¡å™¨ã‚’ä½œã£ã¦ã¿ã‚‹ (6) å­¦ç¿’ ãã®1ï¼ˆæœ¬è¨˜äº‹ï¼‰

# ä»Šå›ã®å†…å®¹

[å‰å›](202103-pornography-classifier-6)ã®è¨˜äº‹ã‹ã‚‰éšåˆ†ã¨é–“ãŒé–‹ã„ã¦ã—ã¾ã„ã¾ã—ãŸã€‚
ä»Šå›ã¯ã€Œãƒ©ãƒ™ãƒ«ä»˜ã‘ã€ã«ã¤ã„ã¦æ›¸ãã¤ã‚‚ã‚Šã§ã—ãŸãŒã€ãã‚ãã‚å‰ç½®ããŒé•·ããªã£ã¦é£½ãã¦ããŸèª­è€…ãŒã„ãã†ãªã®ã§ã€ä»Šå›ã¯ã€Œå­¦ç¿’ã€ã«ã¤ã„ã¦æ›¸ããŸã„ã¨æ€ã„ã¾ã™ã€‚

# çµè«–

æœ€åˆã«çµè«–ã‚’æ›¸ã„ã¦ãŠãã¨ã€ç²¾åº¦ï¼ˆAccuracyï¼‰ãŒ84%ç¨‹åº¦ã®ãƒ¢ãƒ‡ãƒ«ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
ä»Šå›ã¯ã»ã¨ã‚“ã©å·¥å¤«ã¯ã—ã¦ãŠã‚‰ãšã€ã‹ãªã‚Šã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹æˆã§ã™ã€‚æ§˜ã€…ãªæ‰‹æ³•ã‚’é©ç”¨ã™ã‚‹ã“ã¨ã§ã€ã•ã‚‰ã«æ•°%ã¯ç²¾åº¦ã‚’é«˜ã‚ã‚‰ã‚Œãã†ãªæ°—ãŒã—ã¦ã„ã¾ã™ã€‚

# ç’°å¢ƒ

å­¦ç¿’ã§ã¯ã€ä»¥ä¸‹ã®ç’°å¢ƒã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚å­¦ç¿’ã¯Dockerå†…ã§è¡Œã£ã¦ã„ã‚‹ã®ã§ã€GPUã•ãˆèªè­˜ã§ãã‚Œã°Dockerãƒ›ã‚¹ãƒˆå´ã®ç’°å¢ƒã¯ã‚ã¾ã‚Šé–¢ä¿‚ãªã„ã¨æ€ã„ã¾ã™ã€‚

* ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢:
    * CPU: AMD Ryzen 7 3700Xï¼ˆ8ã‚³ã‚¢/16ã‚¹ãƒ¬ãƒƒãƒ‰ï¼‰
    * ãƒ¡ãƒ¢ãƒª: 64GB
    * GPU: GeForce GTX 1070ï¼ˆãƒ¡ãƒ¢ãƒª8GBï¼‰
* ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢:
    * OS: Ubuntu 20.04.2 LTS
    * Docker: 19.03.8
    * NVIDIAãƒ‰ãƒ©ã‚¤ãƒ: 460.39
    * Dockerã‚³ãƒ³ãƒ†ãƒŠå†…:
        * CUDA: 11.0.3
        * cuDNN: 8
        * Python: 3.8.5
        * TensorFlow: 2.4.1

# ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯

ä»Šå›ã¯æ©Ÿæ¢°å­¦ç¿’ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦ã€TensorFlowã«å†…è”µã•ã‚Œã¦ã„ã‚‹é«˜ãƒ¬ãƒ™ãƒ«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã€ŒKerasã€ï¼ˆ[Wikipedia](https://ja.wikipedia.org/wiki/Keras)ï¼‰ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚
EfficientNetã®å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ãŒæä¾›ã•ã‚Œã¦ã„ãŸã®ãŒä¸»ãªç†ç”±ã§ã™ã€‚

# ãƒ¢ãƒ‡ãƒ«

ä»Šå›ã¯ç”»åƒåˆ†é¡ã®ãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦ã€ŒEfficientNet B0ã€ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚
EfficientNetã¯2019å¹´5æœˆã«Googleã®ç ”ç©¶è€…ãŒç™ºè¡¨ã—ãŸãƒ¢ãƒ‡ãƒ«ã§ã€æ¯”è¼ƒçš„å°‘ãªã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°ã§ã‚ˆã„ç²¾åº¦ã‚’å¾—ã‚‰ã‚Œã‚‹ã‚‰ã—ã„ã§ã™ã€‚
ã¾ãŸã€EfficientNetã«ã¯B0ã‹ã‚‰B7ã¾ã§ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ãŒã€ä¸€ç•ªã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªã‚‰B0ã‚’ä½¿ã„ã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ã€[TensorFlow Hub](https://tfhub.dev/google/collections/efficientnet)ã§æä¾›ã•ã‚Œã¦ã„ã‚‹EfficientNet B0ã®å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ï¼ˆPretrained Modelï¼‰ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚ã“ã®å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã¯ImageNetã§äº‹å‰å­¦ç¿’ã•ã‚Œã¦ã„ã¾ã™ã€‚

ä»Šå›ã¯ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆFine Tuningï¼‰ã¯è¡Œã‚ãšã€è»¢ç§»å­¦ç¿’ï¼ˆTransfer Learningï¼‰ã®ã¿ã‚’è¡Œã„ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã«ã¯åˆ¥ã®æ©Ÿä¼šã«ãƒˆãƒ©ã‚¤ã—ã¦ã¿ãŸã„ã§ã™ã€‚

**å‚è€ƒ:**

* [2019å¹´æœ€å¼·ã®ç”»åƒèªè­˜ãƒ¢ãƒ‡ãƒ«EfficientNetè§£èª¬ - Qiita](https://qiita.com/omiita/items/83643f78baabfa210ab1)
* [EfficientNet Explained | Papers With Code](https://paperswithcode.com/method/efficientnet)
* [EfficientNetã‚’æœ€é€Ÿã§è©¦ã™æ–¹æ³• - Qiita](https://qiita.com/wakame1367/items/d90fa56bd9d11c4db50e)

# ãƒ‡ãƒ¼ã‚¿ã®æ¦‚è¦

ä»Šå›ã¯ãƒ©ãƒ™ãƒ«ä»˜ãã®ç”»åƒãƒ‡ãƒ¼ã‚¿22,640æšã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚å†…è¨³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

| å†…å®¹ | æšæ•° | ãƒ©ãƒ™ãƒ« |
|:---|---:|:---:|
| ã‘ã—ã‹ã‚‰ã‚“ããªã„ç”»åƒ | 7,617æš | `0` |
| ã‘ã—ã‹ã‚‰ã‚“ç”»åƒ | 15,023æš | `1` |

ä¸–ã®ä¸­ã«ã¯ã€Œã‘ã—ã‹ã‚‰ã‚“ç”»åƒã€ã°ã‹ã‚Šãªã®ã§ã€ã„ã‚ã‚†ã‚‹ã€Œä¸å‡è¡¡ãƒ‡ãƒ¼ã‚¿ã€ï¼ˆImbalanced Dataï¼‰ã«ãªã£ã¦ã„ã¾ã™ã€‚ã¡ãªã¿ã«ä»Šå›ã¯ä¸å‡è¡¡ã•ã¯è€ƒæ…®ã—ã¦ã„ã¾ã›ã‚“ã€‚ä»Šå¾Œã®èª²é¡Œã¨ã„ã†ã“ã¨ã§ã€‚

ãƒ‡ãƒ¼ã‚¿ã®å…·ä½“ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚å…ˆé ­è¡Œã¯ãƒ˜ãƒƒãƒ€è¡Œã§ã€ä»¥é™ã®è¡Œã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆIDï¼ˆéå»ã®è¨˜äº‹ã‚’å‚ç…§ï¼‰ã¨ãƒ©ãƒ™ãƒ«ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚

```text
$ wc -l /mnt/data/label.csv
22641 /mnt/data/label.csv

$ head -n 5 /mnt/data/label.csv
objectId,value
00002562b453e832e61233eadc2f883a22ad3853.jpg,1
00005166b19153cb07cdf6d4ec5cd1980470483a.jpg,1
00007055678527787afd8bc8f26b6f6def4656a3.jpg,1
00007d225637a27040fee6408184ee4621a2264e.jpg,0
```

# ãƒ‡ãƒ¼ã‚¿ã®åˆ†å‰²

ä¸Šè¨˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ï¼ˆTraining Dataã€è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã¨ã‚‚ï¼‰80%ã€æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿ï¼ˆValidation Dataï¼‰10%ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆTest Dataï¼‰10%ã«åˆ†å‰²ã—ã¦ä½¿ç”¨ã—ã¾ã—ãŸã€‚
å¯èƒ½ãªé™ã‚Šåˆ†å‰²å…ˆã‚’ç¶­æŒã™ã‚‹ãŸã‚ã«ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆIDï¼ˆSHA-1ãƒãƒƒã‚·ãƒ¥å€¤ï¼‰ã«åŸºã¥ã„ã¦åˆ†å‰²ã‚’è¡Œã„ã¾ã—ãŸã€‚

å…·ä½“çš„ã«ã¯ã€SHA-1ãƒãƒƒã‚·ãƒ¥å€¤ã¯160ãƒ“ãƒƒãƒˆï¼ˆ20ãƒã‚¤ãƒˆï¼‰ã‚ã‚Šã¾ã™ãŒã€ãã®ä¸‹ä½1ãƒã‚¤ãƒˆï¼ˆ256ç¨®é¡ï¼‰ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†å‰²ã—ã¾ã—ãŸã€‚
ä¸‹ä½1ãƒã‚¤ãƒˆãŒ0ã€œ24ã‚’ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã€25ã€œ49ã‚’æ¤œè¨¼ç”¨ãƒ‡ãƒ¼ã‚¿ã€æ®‹ã‚Šã‚’å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¾ã—ãŸã€‚
ã¾ãŸã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã€æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹è©•ä¾¡ã‚’å®¹æ˜“ã«ã™ã‚‹ãŸã‚ã«ã€ãã‚Œãã‚Œãƒ©ãƒ™ãƒ«ã®å°‘ãªã„æ–¹ã«æ•°ã‚’åˆã‚ã›ã€ä½™ã£ãŸãƒ‡ãƒ¼ã‚¿ã¯å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¾ã—ãŸã€‚

è¨€è‘‰ã§èª¬æ˜ã™ã‚‹ã‚ˆã‚Šã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦é ‚ãæ–¹ãŒç¢ºå®Ÿã§ã™ã­ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†å‰²ã™ã‚‹Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```py
#!/usr/bin/env python3

import re

import pandas as pd

df = pd.read_csv("/mnt/data/label.csv")
print("df:", len(df))

value_0 = df["value"] == 0
value_1 = df["value"] == 1
print("df.0:", len(df[value_0]))
print("df.1:", len(df[value_1]))

df["type"] = "train"

split_key = df["objectId"].apply(
    lambda object_id: int(re.sub("\\..+$", "", object_id)[-2:], 16)
)
df.loc[(split_key >= 0) & (split_key <= 24), "type"] = "test"
df.loc[(split_key >= 25) & (split_key <= 49), "type"] = "validation"

test_0 = (df["type"] == "test") & value_0
test_1 = (df["type"] == "test") & value_1
test_min = min(len(df[test_0]), len(df[test_1]))
print("test_min:", test_min)
df.loc[df[test_0].index[test_min:], "type"] = "train"
df.loc[df[test_1].index[test_min:], "type"] = "train"

validation_0 = (df["type"] == "validation") & value_0
validation_1 = (df["type"] == "validation") & value_1
validation_min = min(len(df[validation_0]), len(df[validation_1]))
print("validation_min:", validation_min)
df.loc[df[validation_0].index[validation_min:], "type"] = "train"
df.loc[df[validation_1].index[validation_min:], "type"] = "train"

print("train.0:", len(df[(df["type"] == "train") & value_0]))
print("train.1:", len(df[(df["type"] == "train") & value_1]))
print("test.0:", len(df[(df["type"] == "test") & value_0]))
print("test.1:", len(df[(df["type"] == "test") & value_1]))
print("validation.0:", len(df[(df["type"] == "validation") & value_0]))
print("validation.1:", len(df[(df["type"] == "validation") & value_1]))

df.to_csv("split_label.csv", index=False)
```

å®Ÿè¡Œçµæœã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```text
$ ./split.py
df: 22640
df.0: 7617
df.1: 15023
test_min: 744
validation_min: 747
train.0: 6126
train.1: 13532
test.0: 744
test.1: 744
validation.0: 747
validation.1: 747
```

è¡¨ã«ã™ã‚‹ã¨ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

| ç¨®åˆ¥ | ãƒ©ãƒ™ãƒ«`0` | ãƒ©ãƒ™ãƒ«`1` | åˆè¨ˆ |
|:---|---:|---:|---:|
| å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ | 6,126 | 13,532 | 19,658 |
| æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿ | 747 | 747 | 1,494 |
| ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ | 744 | 744 | 1,488 |
| åˆè¨ˆ | 7,617 | 15,023 | 22,640 |

**å‚è€ƒ:**

* [ML Design Pattern #5: Repeatable sampling | by Lak Lakshmanan | Towards Data Science](https://towardsdatascience.com/ml-design-pattern-5-repeatable-sampling-c0ccb2889f39)

# ãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç†


# å­¦ç¿’


# å‚è€ƒ
